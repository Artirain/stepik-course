---
title: "Урок 26. Саб-агенты (Sub-agents)"
description: "Как Claude Code делегирует подзадачи дочерним агентам с изолированным контекстом"
---

# Саб-агенты (Sub-agents)

!!! info "Что ты узнаешь"
    - Что такое саб-агенты и зачем они нужны
    - Как работает изоляция контекста
    - Какие встроенные саб-агенты существуют

## Введение

Когда ты даёшь Claude Code сложную задачу, он не обязан решать всё сам. Он может породить **саб-агента** --- дочерний процесс, который получает конкретную подзадачу, выполняет её и возвращает результат.

Это похоже на то, как менеджер делегирует задачи команде: вместо того чтобы делать всё самому, он раздаёт задания специалистам.

## Зачем нужны саб-агенты

Главная проблема длинных сессий Claude Code --- **контекстное окно**. Оно ограничено. Каждое действие, каждый прочитанный файл, каждый вывод команды занимает место.

Саб-агенты решают эту проблему:

- **Изоляция контекста.** Саб-агент работает в своём контекстном окне. Он не засоряет контекст основного агента промежуточными данными.
- **Фокусировка.** Саб-агент получает узкую задачу и сосредоточен только на ней.
- **Параллелизм.** Несколько саб-агентов могут работать одновременно над разными подзадачами.

## Как это работает

Процесс делегирования выглядит так:

```
Основной агент (parent)
├── Получает сложную задачу
├── Разбивает её на подзадачи
├── Запускает саб-агент #1 → получает результат
├── Запускает саб-агент #2 → получает результат
└── Объединяет результаты и отвечает
```

Каждый саб-агент:

1. Получает **промпт** с описанием подзадачи
2. Работает в **изолированном контексте**
3. Имеет доступ к **ограниченному набору инструментов**
4. Возвращает **результат** родительскому агенту

!!! note "Важно"
    Саб-агент не видит историю разговора основного агента. Он получает только тот промпт, который ему явно передали.

## Встроенные паттерны саб-агентов

Claude Code использует саб-агентов автоматически в некоторых ситуациях. Вот основные паттерны:

### Explore (исследование)

Когда Claude Code нужно разобраться в незнакомой части кодовой базы, он может запустить саб-агента для исследования:

- Саб-агент просматривает файлы, ищет зависимости, строит карту проекта
- Результат --- краткая сводка, которая возвращается в основной контекст
- Основной агент не тратит своё контекстное окно на чтение всех файлов

### Plan (планирование)

Для сложных задач Claude Code может запустить саб-агента-планировщика:

- Саб-агент анализирует задачу и составляет пошаговый план
- Основной агент получает готовый план и выполняет его
- Это экономит контекст и улучшает качество планирования

### Task (выполнение подзадачи)

Claude Code может запустить саб-агента с инструментом `Task` для выполнения конкретной подзадачи:

```
Основной агент: "Рефактори модуль авторизации"
  └── Task саб-агент: "Найди все файлы, связанные с auth"
      └── Результат: список файлов и их зависимостей
```

## Изоляция контекста на практике

Допустим, ты просишь Claude Code: *"Проанализируй весь проект и составь отчёт об архитектуре"*.

**Без саб-агентов:**

```
Контекст основного агента:
├── Чтение файла 1... (500 токенов)
├── Чтение файла 2... (800 токенов)
├── Чтение файла 3... (600 токенов)
├── ... ещё 50 файлов ...
└── Контекст переполнен, качество падает
```

**С саб-агентами:**

```
Контекст основного агента:
├── Запуск саб-агента → "Изучи модуль auth"
│   └── Результат: "Модуль auth содержит 5 файлов, использует JWT..."
├── Запуск саб-агента → "Изучи модуль database"
│   └── Результат: "Модуль database использует Prisma ORM..."
└── Итоговый контекст: компактные сводки вместо сырых файлов
```

Результат: основной агент работает с чистыми, сжатыми данными.

## Когда Claude Code использует саб-агентов

Claude Code сам решает, когда запускать саб-агентов. Обычно это происходит при:

- **Больших объёмах кода** --- нужно прочитать много файлов
- **Сложных задачах** --- нужно разбить на этапы
- **Исследовании** --- нужно понять структуру проекта
- **Параллельных операциях** --- можно выполнять несколько задач одновременно

Ты также можешь **явно попросить** Claude Code использовать саб-агентов:

```
Используй саб-агента, чтобы изучить модуль payments,
а затем рефактори его на основе результатов.
```

## Ограничения саб-агентов

Саб-агенты --- мощный инструмент, но у них есть ограничения:

- **Нет общего состояния.** Саб-агенты не могут общаться друг с другом напрямую.
- **Ограниченные инструменты.** Саб-агент может иметь доступ только к чтению, но не к записи.
- **Накладные расходы.** Запуск саб-агента тоже стоит токенов на промпт и результат.
- **Потеря нюансов.** Краткая сводка может упустить важные детали.

## Практика

Попробуй управлять саб-агентами в Claude Code.

**Эксперимент 1.** Дай Claude Code задачу, которая требует исследования:

```
Изучи структуру проекта и составь карту зависимостей
между модулями. Используй саб-агентов для анализа
каждого модуля отдельно.
```

**Эксперимент 2.** Попроси явно делегировать:

```
Запусти саб-агента, чтобы он нашёл все TODO-комментарии
в проекте и составил список с приоритетами.
```

**Эксперимент 3.** Сравни результаты с и без саб-агентов для одной и той же задачи. Обрати внимание на расход токенов и качество ответа.

## Итоги

- Саб-агенты --- дочерние процессы, которым делегируются подзадачи
- Главное преимущество --- изоляция контекста и экономия токенов
- Встроенные паттерны: Explore, Plan, Task
- Claude Code сам решает, когда использовать саб-агентов, но ты можешь попросить явно
- У саб-агентов нет общего состояния, и они могут иметь ограниченный набор инструментов

## Проверь себя

<div class="quiz-block" data-quiz-id="u26-q1" data-answer="b" markdown>
  <div class="quiz-question">Какую главную проблему решают саб-агенты?</div>
  <label><input type="radio" name="u26-q1" value="a"> Медленную скорость ответа</label>
  <label><input type="radio" name="u26-q1" value="b"> Ограниченное контекстное окно</label>
  <label><input type="radio" name="u26-q1" value="c"> Отсутствие доступа к интернету</label>
  <button class="quiz-btn" onclick="checkQuiz(this)">Проверить</button>
  <div class="quiz-result"></div>
</div>

<div class="quiz-block" data-quiz-id="u26-q2" data-answer="a" markdown>
  <div class="quiz-question">Видит ли саб-агент историю разговора основного агента?</div>
  <label><input type="radio" name="u26-q2" value="a"> Нет, он работает в изолированном контексте</label>
  <label><input type="radio" name="u26-q2" value="b"> Да, он наследует весь контекст</label>
  <label><input type="radio" name="u26-q2" value="c"> Частично --- только последние 10 сообщений</label>
  <button class="quiz-btn" onclick="checkQuiz(this)">Проверить</button>
  <div class="quiz-result"></div>
</div>

<div class="quiz-block" data-quiz-id="u26-q3" data-answer="c" markdown>
  <div class="quiz-question">Какой паттерн саб-агента используется для анализа незнакомого кода?</div>
  <label><input type="radio" name="u26-q3" value="a"> Plan</label>
  <label><input type="radio" name="u26-q3" value="b"> Task</label>
  <label><input type="radio" name="u26-q3" value="c"> Explore</label>
  <button class="quiz-btn" onclick="checkQuiz(this)">Проверить</button>
  <div class="quiz-result"></div>
</div>

<div class="quiz-block" data-quiz-id="u26-q4" data-answer="a" markdown>
  <div class="quiz-question">Могут ли саб-агенты общаться друг с другом напрямую?</div>
  <label><input type="radio" name="u26-q4" value="a"> Нет, у них нет общего состояния</label>
  <label><input type="radio" name="u26-q4" value="b"> Да, через общую память</label>
  <label><input type="radio" name="u26-q4" value="c"> Да, через файловую систему</label>
  <button class="quiz-btn" onclick="checkQuiz(this)">Проверить</button>
  <div class="quiz-result"></div>
</div>
